name: 98tang Auto Sign-in

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹æ‰§è¡Œ (UTC+8 = UTC+0-8, æ‰€ä»¥9ç‚¹å¯¹åº”UTC 1ç‚¹)
    - cron: '0 1 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  autosign:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: éªŒè¯å¿…éœ€é…ç½®
      run: |
        if [ -z "${{ secrets.SITE_USERNAME }}" ] || [ -z "${{ secrets.SITE_PASSWORD }}" ]; then
          echo "âŒ ç¼ºå°‘å¿…éœ€çš„ Secrets é…ç½®"
          echo "è¯·åœ¨ä»“åº“è®¾ç½®ä¸­æ·»åŠ  SITE_USERNAME å’Œ SITE_PASSWORD"
          exit 1
        fi
        echo "âœ… é…ç½®éªŒè¯é€šè¿‡"
        
    - name: æ‰§è¡Œè‡ªåŠ¨ç­¾åˆ°
      env:
        # å¿…éœ€é…ç½®
        SITE_USERNAME: ${{ secrets.SITE_USERNAME }}
        SITE_PASSWORD: ${{ secrets.SITE_PASSWORD }}
        
        # å®‰å…¨æé—®é…ç½®
        ENABLE_SECURITY_QUESTION: ${{ vars.ENABLE_SECURITY_QUESTION || 'false' }}
        SECURITY_QUESTION: ${{ secrets.SECURITY_QUESTION }}
        SECURITY_ANSWER: ${{ secrets.SECURITY_ANSWER }}
        
        # æ ¸å¿ƒåŠŸèƒ½é…ç½®
        BASE_URL: ${{ vars.BASE_URL || 'https://www.sehuatang.org' }}
        ENABLE_CHECKIN: ${{ vars.ENABLE_CHECKIN || 'true' }}
        
        # æ‹ŸäººåŒ–è¡Œä¸ºé…ç½®
        ENABLE_REPLY: ${{ vars.ENABLE_REPLY || 'false' }}
        REPLY_COUNT: ${{ vars.REPLY_COUNT || '2' }}
        ENABLE_RANDOM_BROWSING: ${{ vars.ENABLE_RANDOM_BROWSING || 'false' }}
        BROWSE_PAGE_COUNT: ${{ vars.BROWSE_PAGE_COUNT || '3' }}
        COMMENT_INTERVAL: ${{ vars.COMMENT_INTERVAL || '15' }}
        WAIT_AFTER_LOGIN: ${{ vars.WAIT_AFTER_LOGIN || '5' }}
        REPLY_MESSAGES: ${{ vars.REPLY_MESSAGES || 'æ„Ÿè°¢åˆ†äº«èµ„æºï¼Œæ”¶è—äº†;å¥½èµ„æºæ”¶è—äº†ï¼Œè°¢è°¢æ¥¼ä¸»;æ„Ÿè°¢æ¥¼ä¸»çš„ç²¾å½©åˆ†äº«;è°¢è°¢åˆ†äº«ï¼Œéå¸¸å®ç”¨;å¥½å†…å®¹ï¼Œæ”¯æŒä¸€ä¸‹æ¥¼ä¸»' }}
        
        # å»¶è¿Ÿä¼˜åŒ–é…ç½®
        TIMING_MULTIPLIER: ${{ vars.TIMING_MULTIPLIER || '1.0' }}
        ENABLE_SMART_TIMING: ${{ vars.ENABLE_SMART_TIMING || 'true' }}
        
        # Telegramé€šçŸ¥é…ç½®
        ENABLE_TELEGRAM_NOTIFICATION: ${{ vars.ENABLE_TELEGRAM_NOTIFICATION || 'false' }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_PROXY_URL: ${{ secrets.TELEGRAM_PROXY_URL }}
        TELEGRAM_SEND_LOG_FILE: ${{ vars.TELEGRAM_SEND_LOG_FILE || 'false' }}
        
        # ç³»ç»Ÿé…ç½®ï¼ˆå¼ºåˆ¶è®¾ç½®ï¼‰
        HEADLESS: 'true'  # Github Action å¼ºåˆ¶æ— å¤´æ¨¡å¼
        LOG_LEVEL: ${{ vars.LOG_LEVEL || 'INFO' }}
        MAX_LOG_FILES: ${{ vars.MAX_LOG_FILES || '7' }}
        MAX_RETRIES: ${{ vars.MAX_RETRIES || '3' }}
        TIMEOUT_MINUTES: ${{ vars.TIMEOUT_MINUTES || '5' }}
        
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œè‡ªåŠ¨ç­¾åˆ°..."
        echo "ğŸ“… æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S') UTC"
        echo "ğŸŒ åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ‘¤ ç”¨æˆ·å: $(echo $SITE_USERNAME | head -c 2)****$(echo $SITE_USERNAME | tail -c 3)"
        echo "ğŸ”— ç›®æ ‡ç½‘ç«™: $BASE_URL"
        echo ""
        
        python main.py
        
    - name: ä¸Šä¼ æ—¥å¿—æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: autosign-logs-${{ github.run_number }}
        path: logs/
        retention-days: 30
        
    - name: æ‰§è¡Œç»“æœé€šçŸ¥
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "âœ… è‡ªåŠ¨ç­¾åˆ°æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ è‡ªåŠ¨ç­¾åˆ°æ‰§è¡Œå¤±è´¥"
          echo "è¯·æŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯"
        fi