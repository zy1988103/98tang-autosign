# 98tang Auto Sign-in
# å®Œæ•´é…ç½®è¯´æ˜è¯·å‚è€ƒ: docs/configuration.md
name: 98tang Auto Sign-in

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´0:00æ‰§è¡Œ (UTC+8 = UTC+0-8, æ‰€ä»¥0ç‚¹å¯¹åº”UTC 16ç‚¹)
    # æ³¨æ„ï¼šschedule åªåœ¨é»˜è®¤åˆ†æ”¯(main)ä¸Šè¿è¡Œ
    - cron: '0 16 * * *'   # åŒ—äº¬æ—¶é—´ 0:00
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘ - å¯åœ¨ä»»ä½•åˆ†æ”¯è¿è¡Œ
  push:
    # å½“æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘ï¼ˆdevelopåˆ†æ”¯ä¸ä¼šè‡ªåŠ¨è¿è¡Œï¼‰
    branches: [ main ]
  pull_request:
    # å½“åˆ›å»ºPRåˆ°æŒ‡å®šåˆ†æ”¯æ—¶è§¦å‘ï¼ˆå¯é€‰ï¼Œç”¨äºæµ‹è¯•ï¼‰
    branches: [ main ]

jobs:
  # Environment secretsæ¨¡å¼ï¼ˆä¼˜å…ˆï¼‰- ä½¿ç”¨98tang-autosignç¯å¢ƒ
  autosign-environment:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: 98tang-autosign
    # ç¡®ä¿åªåœ¨mainåˆ†æ”¯ä¸Šè¿è¡Œè‡ªåŠ¨ç­¾åˆ°
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    outputs:
      failure_reason: ${{ steps.check_config.outputs.failure_reason }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–å’Œä¸­æ–‡å­—ä½“
      run: |
        # æ›´æ–°åŒ…ç®¡ç†å™¨
        sudo apt-get update
        
        # å®‰è£…ä¸­æ–‡å­—ä½“æ”¯æŒ
        sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
        sudo apt-get install -y language-pack-zh-hans
        
        # è®¾ç½®å­—ä½“ç¼“å­˜
        sudo fc-cache -fv
        
        # éªŒè¯ä¸­æ–‡å­—ä½“å®‰è£…
        echo "âœ… å·²å®‰è£…çš„ä¸­æ–‡å­—ä½“:"
        fc-list :lang=zh | head -5
        
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: éªŒè¯å¿…éœ€é…ç½®
      id: check_config
      run: |
        if [ -z "${{ secrets.SITE_USERNAME }}" ] || [ -z "${{ secrets.SITE_PASSWORD }}" ]; then
          echo "âŒ ç¼ºå°‘å¿…éœ€çš„ Environment Secrets é…ç½®"
          echo "è¯·åœ¨ä»“åº“è®¾ç½®çš„ 98tang-autosign ç¯å¢ƒä¸­æ·»åŠ  SITE_USERNAME å’Œ SITE_PASSWORD"
          echo "failure_reason=missing_environment_secrets" >> $GITHUB_OUTPUT
          exit 1
        fi
        echo "âœ… é…ç½®éªŒè¯é€šè¿‡ (Environment secretsæ¨¡å¼: 98tang-autosign)"
        
    - name: æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´
      run: |
        echo "â° å½“å‰UTCæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸŒ å½“å‰åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œè‡ªåŠ¨ç­¾åˆ°ä»»åŠ¡"
        
    - name: æ‰§è¡Œè‡ªåŠ¨ç­¾åˆ°
      env:
        # å¿…éœ€é…ç½®
        SITE_USERNAME: ${{ secrets.SITE_USERNAME }}
        SITE_PASSWORD: ${{ secrets.SITE_PASSWORD }}
        
        # å®‰å…¨æé—®é…ç½®
        ENABLE_SECURITY_QUESTION: ${{ vars.ENABLE_SECURITY_QUESTION || 'false' }}
        SECURITY_QUESTION: ${{ secrets.SECURITY_QUESTION }}
        SECURITY_ANSWER: ${{ secrets.SECURITY_ANSWER }}
        
        # æ ¸å¿ƒåŠŸèƒ½é…ç½®
        BASE_URL: ${{ vars.BASE_URL || 'https://www.sehuatang.org' }}
        ENABLE_CHECKIN: ${{ vars.ENABLE_CHECKIN || 'true' }}
        
        # æ‹ŸäººåŒ–è¡Œä¸ºé…ç½®
        ENABLE_REPLY: ${{ vars.ENABLE_REPLY || 'true' }}
        REPLY_COUNT: ${{ vars.REPLY_COUNT || '2' }}
        ENABLE_RANDOM_BROWSING: ${{ vars.ENABLE_RANDOM_BROWSING || 'true' }}
        BROWSE_PAGE_COUNT: ${{ vars.BROWSE_PAGE_COUNT || '3' }}
        COMMENT_INTERVAL: ${{ vars.COMMENT_INTERVAL || '15' }}
        WAIT_AFTER_LOGIN: ${{ vars.WAIT_AFTER_LOGIN || '5' }}
        REPLY_MESSAGES: ${{ vars.REPLY_MESSAGES || 'æ„Ÿè°¢åˆ†äº«èµ„æºï¼Œæ”¶è—äº†;å¥½èµ„æºæ”¶è—äº†ï¼Œè°¢è°¢æ¥¼ä¸»;æ„Ÿè°¢æ¥¼ä¸»çš„ç²¾å½©åˆ†äº«;è°¢è°¢åˆ†äº«ï¼Œæ„Ÿè°¢ç²¾å½©èµ„æº;å¥½å†…å®¹ï¼Œæ”¯æŒä¸€ä¸‹æ¥¼ä¸»' }}
        
        # å»¶è¿Ÿä¼˜åŒ–é…ç½®
        TIMING_MULTIPLIER: ${{ vars.TIMING_MULTIPLIER || '1.0' }}
        ENABLE_SMART_TIMING: ${{ vars.ENABLE_SMART_TIMING || 'true' }}
        
        # Telegramé€šçŸ¥é…ç½®
        ENABLE_TELEGRAM_NOTIFICATION: ${{ vars.ENABLE_TELEGRAM_NOTIFICATION || 'false' }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_PROXY_URL: ${{ secrets.TELEGRAM_PROXY_URL }}
        TELEGRAM_SEND_LOG_FILE: ${{ vars.TELEGRAM_SEND_LOG_FILE || 'true' }}  # GitHub Actions é»˜è®¤å¯ç”¨æ—¥å¿—æ¨é€
        TELEGRAM_SEND_SCREENSHOT: ${{ vars.TELEGRAM_SEND_SCREENSHOT || 'false' }}  # GitHub Actions é»˜è®¤å¯ç”¨æˆªå›¾
        
        # ç³»ç»Ÿé…ç½®ï¼ˆå¼ºåˆ¶è®¾ç½®ï¼‰
        HEADLESS: 'true'  # Github Action å¼ºåˆ¶æ— å¤´æ¨¡å¼
        LOG_LEVEL: ${{ vars.LOG_LEVEL || 'DEBUG' }}  # GitHub Actions é»˜è®¤ä½¿ç”¨ DEBUG çº§åˆ«
        MAX_LOG_FILES: ${{ vars.MAX_LOG_FILES || '7' }}
        MAX_RETRIES: ${{ vars.MAX_RETRIES || '3' }}
        TIMEOUT_MINUTES: ${{ vars.TIMEOUT_MINUTES || '5' }}
        
        # ä¸­æ–‡å­—ä½“å’Œç¼–ç æ”¯æŒ
        LANG: 'zh_CN.UTF-8'
        LC_ALL: 'zh_CN.UTF-8'
        PYTHONIOENCODING: 'utf-8'
        PYTHONUTF8: '1'
        
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œè‡ªåŠ¨ç­¾åˆ° (Environment secretsæ¨¡å¼: 98tang-autosign)..."
        echo "ğŸ“… å®é™…æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S') UTC"
        echo "ğŸŒ åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        echo "â° è°ƒåº¦ç­–ç•¥: åŒ—äº¬æ—¶é—´0:00~0:30éšæœºæ‰§è¡Œ"
        echo "ğŸ‘¤ ç”¨æˆ·å: $(echo $SITE_USERNAME | head -c 2)****$(echo $SITE_USERNAME | tail -c 3)"
        echo "ğŸ”— ç›®æ ‡ç½‘ç«™: $BASE_URL"
        echo ""
        
        python main.py
        
    - name: ä¸Šä¼ æ—¥å¿—å’Œè°ƒè¯•æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: autosign-logs-environment-${{ github.run_number }}
        path: |
          logs/
        retention-days: 30
        
    - name: æ‰§è¡Œç»“æœé€šçŸ¥
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "âœ… è‡ªåŠ¨ç­¾åˆ°æ‰§è¡ŒæˆåŠŸ (Environment secretsæ¨¡å¼: 98tang-autosign)"
        else
          echo "âŒ è‡ªåŠ¨ç­¾åˆ°æ‰§è¡Œå¤±è´¥"
          echo "è¯·æŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯"
        fi

  # Repository secretsæ¨¡å¼ï¼ˆæ™ºèƒ½å›é€€ï¼‰- å½“Environment secretsä¸å¯ç”¨æ—¶ä½¿ç”¨
  autosign-repository:
    # åªæœ‰å½“Environment secretsæ¨¡å¼å¤±è´¥ä¸”æ˜¯é…ç½®é—®é¢˜æ—¶æ‰è¿è¡Œï¼Œä¸”åªåœ¨mainåˆ†æ”¯ä¸Šè¿è¡Œ
    if: failure() && needs.autosign-environment.result == 'failure' && needs.autosign-environment.outputs.failure_reason == 'missing_environment_secrets' && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    needs: autosign-environment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–å’Œä¸­æ–‡å­—ä½“
      run: |
        # æ›´æ–°åŒ…ç®¡ç†å™¨
        sudo apt-get update
        
        # å®‰è£…ä¸­æ–‡å­—ä½“æ”¯æŒ
        sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
        sudo apt-get install -y language-pack-zh-hans
        
        # è®¾ç½®å­—ä½“ç¼“å­˜
        sudo fc-cache -fv
        
        # éªŒè¯ä¸­æ–‡å­—ä½“å®‰è£…
        echo "âœ… å·²å®‰è£…çš„ä¸­æ–‡å­—ä½“:"
        fc-list :lang=zh | head -5
        
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: éªŒè¯å¿…éœ€é…ç½®
      run: |
        if [ -z "${{ secrets.SITE_USERNAME }}" ] || [ -z "${{ secrets.SITE_PASSWORD }}" ]; then
          echo "âŒ ç¼ºå°‘å¿…éœ€çš„ Repository Secrets é…ç½®"
          echo "è¯·åœ¨ä»“åº“è®¾ç½®ä¸­æ·»åŠ  SITE_USERNAME å’Œ SITE_PASSWORD"
          echo "æˆ–è€…åœ¨ 98tang-autosign ç¯å¢ƒä¸­é…ç½® Environment Secrets"
          exit 1
        fi
        echo "âœ… é…ç½®éªŒè¯é€šè¿‡ (Repository secretsæ¨¡å¼ - å›é€€æ¨¡å¼)"
        echo "âš ï¸ å»ºè®®é…ç½® 98tang-autosign ç¯å¢ƒä»¥è·å¾—æ›´å¥½çš„å®‰å…¨æ€§"
        
    - name: æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´
      run: |
        echo "â° å½“å‰UTCæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸŒ å½“å‰åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œè‡ªåŠ¨ç­¾åˆ°ä»»åŠ¡"
        
    - name: æ‰§è¡Œè‡ªåŠ¨ç­¾åˆ°
      env:
        # å¿…éœ€é…ç½®
        SITE_USERNAME: ${{ secrets.SITE_USERNAME }}
        SITE_PASSWORD: ${{ secrets.SITE_PASSWORD }}
        
        # å®‰å…¨æé—®é…ç½®
        ENABLE_SECURITY_QUESTION: ${{ vars.ENABLE_SECURITY_QUESTION || 'false' }}
        SECURITY_QUESTION: ${{ secrets.SECURITY_QUESTION }}
        SECURITY_ANSWER: ${{ secrets.SECURITY_ANSWER }}
        
        # æ ¸å¿ƒåŠŸèƒ½é…ç½®
        BASE_URL: ${{ vars.BASE_URL || 'https://www.sehuatang.org' }}
        ENABLE_CHECKIN: ${{ vars.ENABLE_CHECKIN || 'true' }}
        
        # æ‹ŸäººåŒ–è¡Œä¸ºé…ç½®
        ENABLE_REPLY: ${{ vars.ENABLE_REPLY || 'true' }}
        REPLY_COUNT: ${{ vars.REPLY_COUNT || '2' }}
        ENABLE_RANDOM_BROWSING: ${{ vars.ENABLE_RANDOM_BROWSING || 'true' }}
        BROWSE_PAGE_COUNT: ${{ vars.BROWSE_PAGE_COUNT || '3' }}
        COMMENT_INTERVAL: ${{ vars.COMMENT_INTERVAL || '15' }}
        WAIT_AFTER_LOGIN: ${{ vars.WAIT_AFTER_LOGIN || '5' }}
        REPLY_MESSAGES: ${{ vars.REPLY_MESSAGES || 'æ„Ÿè°¢åˆ†äº«èµ„æºï¼Œæ”¶è—äº†;å¥½èµ„æºæ”¶è—äº†ï¼Œè°¢è°¢æ¥¼ä¸»;æ„Ÿè°¢æ¥¼ä¸»çš„ç²¾å½©åˆ†äº«;è°¢è°¢åˆ†äº«ï¼Œéå¸¸å®ç”¨;å¥½å†…å®¹ï¼Œæ”¯æŒä¸€ä¸‹æ¥¼ä¸»' }}
        
        # å»¶è¿Ÿä¼˜åŒ–é…ç½®
        TIMING_MULTIPLIER: ${{ vars.TIMING_MULTIPLIER || '1.0' }}
        ENABLE_SMART_TIMING: ${{ vars.ENABLE_SMART_TIMING || 'true' }}
        
        # Telegramé€šçŸ¥é…ç½®
        ENABLE_TELEGRAM_NOTIFICATION: ${{ vars.ENABLE_TELEGRAM_NOTIFICATION || 'false' }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_PROXY_URL: ${{ secrets.TELEGRAM_PROXY_URL }}
        TELEGRAM_SEND_LOG_FILE: ${{ vars.TELEGRAM_SEND_LOG_FILE || 'true' }}  # GitHub Actions é»˜è®¤å¯ç”¨æ—¥å¿—æ¨é€
        TELEGRAM_SEND_SCREENSHOT: ${{ vars.TELEGRAM_SEND_SCREENSHOT || 'true' }}  # GitHub Actions é»˜è®¤å¯ç”¨æˆªå›¾
        
        # ç³»ç»Ÿé…ç½®ï¼ˆå¼ºåˆ¶è®¾ç½®ï¼‰
        HEADLESS: 'true'  # Github Action å¼ºåˆ¶æ— å¤´æ¨¡å¼
        LOG_LEVEL: ${{ vars.LOG_LEVEL || 'DEBUG' }}  # GitHub Actions é»˜è®¤ä½¿ç”¨ DEBUG çº§åˆ«
        MAX_LOG_FILES: ${{ vars.MAX_LOG_FILES || '7' }}
        MAX_RETRIES: ${{ vars.MAX_RETRIES || '3' }}
        TIMEOUT_MINUTES: ${{ vars.TIMEOUT_MINUTES || '5' }}
        
        # ä¸­æ–‡å­—ä½“å’Œç¼–ç æ”¯æŒ
        LANG: 'zh_CN.UTF-8'
        LC_ALL: 'zh_CN.UTF-8'
        PYTHONIOENCODING: 'utf-8'
        PYTHONUTF8: '1'
        
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œè‡ªåŠ¨ç­¾åˆ° (Repository secretsæ¨¡å¼ - å›é€€æ¨¡å¼)..."
        echo "âš ï¸ Environment secrets (98tang-autosign) ä¸å¯ç”¨ï¼Œä½¿ç”¨ Repository secrets"
        echo "ğŸ“… å®é™…æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S') UTC"
        echo "ğŸŒ åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        echo "â° è°ƒåº¦ç­–ç•¥: åŒ—äº¬æ—¶é—´0:00~0:30éšæœºæ‰§è¡Œ"
        echo "ğŸ‘¤ ç”¨æˆ·å: $(echo $SITE_USERNAME | head -c 2)****$(echo $SITE_USERNAME | tail -c 3)"
        echo "ğŸ”— ç›®æ ‡ç½‘ç«™: $BASE_URL"
        echo ""
        
        python main.py
        
    - name: ä¸Šä¼ æ—¥å¿—å’Œè°ƒè¯•æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: autosign-logs-repository-${{ github.run_number }}
        path: |
          logs/
        retention-days: 30
        
    - name: æ‰§è¡Œç»“æœé€šçŸ¥
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "âœ… è‡ªåŠ¨ç­¾åˆ°æ‰§è¡ŒæˆåŠŸ (Repository secretsæ¨¡å¼ - å›é€€æ¨¡å¼)"
          echo "ğŸ’¡ å»ºè®®é…ç½® 98tang-autosign ç¯å¢ƒä»¥è·å¾—æ›´å¥½çš„å®‰å…¨æ€§å’Œç®¡ç†"
        else
          echo "âŒ è‡ªåŠ¨ç­¾åˆ°æ‰§è¡Œå¤±è´¥"
          echo "è¯·æŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯"
        fi